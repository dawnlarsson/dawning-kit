#!/bin/sh
. script/common

kernel_extract_dir="linux/"
download_artifacts_dir="artifacts/"
keys_dir=$download_artifacts_dir"keys/"
trusted_keys="torvalds@kernel.org gregkh@kernel.org"
kernel_version="6.17.7"
kernel_download="https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.17.7.tar.xz"
kernel_pgp="
-----BEGIN PGP SIGNATURE-----
Comment: This signature is for the .tar version of the archive
Comment: git archive --format tar --prefix=linux-6.17.7/ v6.17.7
Comment: git version 2.51.2

iQIzBAABCgAdFiEEZH8oZUiU471FcZm+ONu9yGCSaT4FAmkHWtoACgkQONu9yGCS
aT4hNRAAhHPMrtyXJSfW+oOCz13qkN/EbT5dhsQ1h5GwCNBE5nlzAttRtkTFim9H
MAZbw6+FdZ38GM5DKxme097elA0DjpOqYcDtjR4/yTHvhqOLsqCEhZF3QefHGs3Y
b16hDB9gUOXwLvWQQM+r7KXiCgNwz0br7OaebS2ruASjbWJZ5whWQt6BlO20frmR
721ChxtqSs8dubqbQubJuFie102KJ/HKg62iTNwLrVVv/XFgn/BUoBLiW8zf4NGR
6mOXQfGuncN/wlWM+zxL0pktu9+Z2IocA+6IR2XEKBirj9hyXIZhMf4YJ+2ivA61
akaJ2zZWroO2gmCXYaNBabwUbCbs0E80hP7SLnbmhfK8TE3XujUywUypF+FaMlWI
iItfAHKXsuVhQZsiUrwrTC0RxBBIw+DVT9GRafywHyP38lJ2SJ/nbQunzn+AVok2
9eYLeHfHNCpKLyU9uIYHGy46e9tKFTg9s7i5ygDJ3eNvSujgrXQdUcwAthnbEDRm
18uub9yUxOUKyw8qK9L3y68BTVZ2BuWO6gMiq84OEssnafQNrlOVfAWRaX4qu5Vy
JtKee+6I1guPBPGizE5uCvq6MCe+znFUU0oGUZukbKS1goXB6b3zFfybWY0Nu0jX
tg/+PtNtk2amNK+sgH2m2dS+qcym8qQw84xXfu+sgk4Hn/idemU=
=qGkc
-----END PGP SIGNATURE-----
"

kernel_tarball=$download_artifacts_dir"linux-$kernel_version.tar"
kernel_archive=$kernel_tarball".xz"

if [ -d $kernel_extract_dir ]; then
    echo $BOLD "Kernel already extracted..." $RESET
    exit 0
fi

extract_kernel() {
    echo $BOLD "Checking kernel signature" $RESET
    gpg --locate-keys $trusted_keys

    unxz -k $kernel_archive

    echo "$kernel_pgp" >$kernel_tarball".sign"

    gpg --verify $kernel_tarball".sign" $kernel_tarball

    tar -xf $kernel_tarball --strip-components=1 -C $kernel_extract_dir

    rm $kernel_tarball

    echo $BOLD "Kernel extracted to $kernel_extract_dir" $RESET
}

is_file $kernel_archive ||
    curl -L $kernel_download -o $kernel_archive

mkdir -p $download_artifacts_dir
mkdir -p $kernel_extract_dir

extract_kernel

# check for build dependencies
build_required="bison flex bc gpg make gcc clang rustc"

for pkg in $build_required; do
    if ! command -v "$pkg" > /dev/null 2>&1; then
        echo "$pkg is required to build the kernel. Please install it and try again."
        exit 1
    fi
done