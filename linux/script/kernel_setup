#!/bin/sh
. script/common

kernel_extract_dir="linux/"
download_artifacts_dir="artifacts/"
keys_dir=$download_artifacts_dir"keys/"
trusted_keys="torvalds@kernel.org gregkh@kernel.org"
kernel_version="6.16.4"
kernel_download="https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.16.4.tar.xz"
kernel_pgp="
-----BEGIN PGP SIGNATURE-----
Comment: This signature is for the .tar version of the archive
Comment: git archive --format tar --prefix=linux-6.16.4/ v6.16.4
Comment: git version 2.50.1

iQIzBAABCgAdFiEEZH8oZUiU471FcZm+ONu9yGCSaT4FAmiwaXoACgkQONu9yGCS
aT7BChAAmu+gwtJvLxb67BjvCVAw/DwFstXZ3mq34Nbgu+ct+oPH6sUDBWnB80YS
bK5M+B4eLA4qxRsq1FZxNo/tJpIA2qtW1NtVqStnlBeFG3i2IJJX2oZ392I5uFyF
o2M6HudRjGsSviWNukbu0r/1EJV4AEEqauqu+4C7P8ZbknSJ6Gyjr/319wVDhHnT
sdm8dCYg2Jpda/lAOiW6j42y+Jt9kEpy9ND2AwCTKDe8063Zbby6IMA9QGfYtO3f
ZnovEgd8aa0Kvh6iXdrgSJfdddasF8c78bw+p8VEjw69U1L9l6dNXIi1aU1tP819
Du63U9TjG7coShEpB91lfCDHdHDpkZSXCXlk/zRpb9y5TVcG42Bm3P3aC258dwSS
L6NG6KBFu1ZtXy0X4xySWxJj1/MYJ5Vdm1SV4+WWZZ0QIo4Bdo4+UVFBl+wv9lPF
lSBhdfgY3pO/E/TBwGGeAhVrqpIKEImpPWi4W5CKM2LcybCdJ41WCfO/aEBStL/p
fEYsMyLMm/4q6U2ojPBDCvhJmCH/oCz2ndGVRencMYaCnX/9zb7rk7Z9zUeqWIpC
Tphy0UOkYPLHc56ioeoSDKrkoMpwAIwLDBUwX9T65c3NmLmowfkZFAkEcYSwEpVA
9z9iy6QgYTxlqpeE6AieMhr00NM8yUJmFDWVjvIxzQ7YGBGQDdM=
=arwx
-----END PGP SIGNATURE-----
"

kernel_tarball=$download_artifacts_dir"linux-$kernel_version.tar"
kernel_archive=$kernel_tarball".xz"

if [ -d $kernel_extract_dir ]; then
    echo $BOLD "Kernel already extracted..." $RESET
    exit 0
fi

extract_kernel() {
    echo $BOLD "Checking kernel signature" $RESET
    gpg --locate-keys $trusted_keys

    unxz -k $kernel_archive

    echo "$kernel_pgp" >$kernel_tarball".sign"

    gpg --verify $kernel_tarball".sign" $kernel_tarball

    tar -xf $kernel_tarball --strip-components=1 -C $kernel_extract_dir

    rm $kernel_tarball

    echo $BOLD "Kernel extracted to $kernel_extract_dir" $RESET
}

is_file $kernel_archive ||
    curl -L $kernel_download -o $kernel_archive

mkdir -p $download_artifacts_dir
mkdir -p $kernel_extract_dir

extract_kernel
